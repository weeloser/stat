<!DOCTYPE html><html lang="ru" data-theme="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Счетчик Статистики Pro</title><script src="https://cdn.tailwindcss.com"></script><link rel="icon" href="https://i.ibb.co/2Yg0Wn4/favicon.png" type="image/png"><style>:root{--bg-primary-light:#f4f7fe;--bg-secondary-light:#fff;--text-primary-light:#111827;--text-secondary-light:#4b5563;--border-light:#e5e7eb;--accent-primary:#4f46e5;--accent-secondary:#7c3aed;--accent-gradient:linear-gradient(135deg,var(--accent-primary) 0,var(--accent-secondary) 100%);--success-light:#10b981;--danger-light:#ef4444;--success-bg-light:#f0fdf4;--danger-bg-light:#fef2f2;--success-border-light:#a7f3d0;--danger-border-light:#fecaca;--gray-bg-light:#f3f4f6;--bg-primary-dark:#111827;--bg-secondary-dark:#1f2937;--text-primary-dark:#f9fafb;--text-secondary-dark:#9ca3af;--border-dark:#374151;--success-dark:#34d399;--danger-dark:#f87171;--success-bg-dark:#052e16;--danger-bg-dark:#450a0a;--success-border-dark:#15803d;--danger-border-dark:#b91c1c;--gray-bg-dark:#374151}[data-theme=light]{--bg-primary:var(--bg-primary-light);--bg-secondary:var(--bg-secondary-light);--text-primary:var(--text-primary-light);--text-secondary:var(--text-secondary-light);--border-color:var(--border-light);--success-color:var(--success-light);--danger-color:var(--danger-light);--success-bg:var(--success-bg-light);--danger-bg:var(--danger-bg-light);--success-border:var(--success-border-light);--danger-border:var(--danger-border-light);--gray-bg:var(--gray-bg-light)}[data-theme=dark]{--bg-primary:var(--bg-primary-dark);--bg-secondary:var(--bg-secondary-dark);--text-primary:var(--text-primary-dark);--text-secondary:var(--text-secondary-dark);--border-color:var(--border-dark);--success-color:var(--success-dark);--danger-color:var(--danger-dark);--success-bg:var(--success-bg-dark);--danger-bg:var(--danger-bg-dark);--success-border:var(--success-border-dark);--danger-border:var(--danger-border-dark);--gray-bg:var(--gray-bg-dark)}body{font-family:Inter,sans-serif;background-color:var(--bg-primary);color:var(--text-primary);transition:background-color .3s ease,color .3s ease;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body.animations-disabled *,body.animations-disabled :after,body.animations-disabled :before{animation:none!important;transition:none!important}.container{width:100%;max-width:1000px;margin:2rem auto;padding:1rem}.main-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;margin-bottom:2rem}.main-title{font-size:2.25rem;font-weight:800;color:var(--text-primary);animation:text-focus-in 1s cubic-bezier(.55,.085,.68,.53) both}.btn{padding:.75rem 1.5rem;border-radius:.75rem;font-weight:600;border:none;cursor:pointer;transition:all .2s ease-in-out;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;position:relative;overflow:hidden}.btn-primary{background-image:linear-gradient(135deg,var(--accent-primary) 0,var(--accent-secondary) 50%,var(--accent-primary) 100%);background-size:200% 200%;color:#fff;box-shadow:0 4px 15px -5px rgba(79,70,229,.6);animation:gradient-animation 4s ease infinite}.btn-primary:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 8px 20px -5px rgba(79,70,229,.5)}.btn-secondary{background-color:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color)}.btn-secondary:hover{background-color:var(--gray-bg);transform:translateY(-2px)}.btn-icon{background:0 0;border:1px solid var(--border-color);color:var(--text-secondary);padding:.6rem;border-radius:.75rem;transition:all .3s cubic-bezier(.175,.885,.32,1.275)}.btn-icon:hover{background:var(--gray-bg);color:var(--accent-primary);transform:rotate(15deg) scale(1.1)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.modal-overlay.active{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-secondary);border-radius:1.5rem;padding:2.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;transform:scale(.95) translateY(10px);opacity:0;transition:transform .4s cubic-bezier(.175,.885,.32,1.275),opacity .3s ease;position:relative;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}.modal-overlay.active .modal-content{transform:scale(1) translateY(0);opacity:1}.modal-title{font-size:1.875rem;font-weight:700;color:var(--text-primary);margin-bottom:2rem;text-align:center}.close-button{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary);padding:.5rem;border-radius:99px;line-height:1;transition:transform .2s ease,background-color .2s ease}.close-button:hover{background-color:var(--gray-bg);transform:scale(1.1)}.form-group{margin-bottom:1.5rem}.form-label{display:block;font-weight:500;margin-bottom:.5rem;color:var(--text-secondary)}.form-input,.form-select{width:100%;padding:.75rem 1rem;border-radius:.75rem;border:1px solid var(--border-color);background-color:var(--bg-primary);color:var(--text-primary);transition:border-color .2s,box-shadow .2s}.form-input:focus,.form-select:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 3px rgba(79,70,229,.2)}.statistic-card{background-color:var(--bg-secondary);border-radius:1.5rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -2px rgba(0,0,0,.05);transition:transform .3s cubic-bezier(.175,.885,.32,1.275),box-shadow .3s ease;border:1px solid var(--border-color);cursor:pointer;opacity:0}.statistic-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 10px 15px -3px rgba(0,0,0,.07),0 4px 6px -4px rgba(0,0,0,.07)}.trade-card{background-color:var(--bg-secondary);border-radius:1rem;padding:1.5rem;border:1px solid var(--border-color);transition:background-color .2s ease,transform .3s cubic-bezier(.175,.885,.32,1.275);cursor:pointer;opacity:0}.trade-card:hover{background-color:var(--bg-primary);transform:translateY(-5px)}.profit-loss-green{background-color:var(--success-bg);color:var(--success-color)}.profit-loss-red{background-color:var(--danger-bg);color:var(--danger-color)}.profit-loss-gray{background-color:var(--gray-bg);color:var(--text-secondary)}.color-green{color:var(--success-color)}.color-red{color:var(--danger-color)}.color-gray{color:var(--text-secondary)}#toast{position:fixed;bottom:-100px;left:50%;transform:translateX(-50%);background-color:#2c3e50;color:#fff;padding:1rem 2rem;border-radius:.5rem;box-shadow:0 5px 15px rgba(0,0,0,.2);z-index:2000;transition:all .5s cubic-bezier(.68,-.55,.27,1.55);font-weight:500}#toast.show{bottom:30px;transform:translateX(-50%) scale(1)}.settings-panel{position:fixed;top:0;right:-400px;width:100%;max-width:350px;height:100%;background-color:var(--bg-secondary);box-shadow:-10px 0 30px rgba(0,0,0,.1);z-index:1100;transition:right .4s cubic-bezier(.25,.46,.45,.94);padding:1.5rem;overflow-y:auto;border-left:1px solid var(--border-color)}.settings-panel.active{right:0}.settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}.settings-title{font-size:1.5rem;font-weight:700}.toggle-switch{position:relative;display:inline-block;width:50px;height:28px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:28px}.slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--accent-primary)}input:checked+.slider:before{transform:translateX(22px)}.direction-btn{transition:all .2s ease-in-out;font-weight:700;letter-spacing:.05em;text-transform:uppercase;border:2px solid transparent;flex:1;padding:.75rem;border-radius:.5rem}.direction-btn.selected-long{background-color:var(--success-bg);color:var(--success-color);border-color:var(--success-border);box-shadow:0 0 15px -5px var(--success-bg)}.direction-btn.selected-short{background-color:var(--danger-bg);color:var(--danger-color);border-color:var(--danger-border);box-shadow:0 0 15px -5px var(--danger-bg)}@keyframes fadeInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.animate-fade-in-up{animation:fadeInUp .5s ease-out forwards}@keyframes slideInRight{0%{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateY(0)}}.animate-slide-in-right{animation:slideInRight .5s ease-out forwards}@keyframes slideInLeft{0%{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateY(0)}}.animate-slide-in-left{animation:slideInLeft .5s ease-out forwards}@keyframes text-focus-in{0%{filter:blur(12px);opacity:0}to{filter:blur(0);opacity:1}}@keyframes pulsate{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(79,70,229,.4)}70%{transform:scale(1.02);box-shadow:0 0 10px 10px transparent}to{transform:scale(1);box-shadow:0 0 0 0 transparent}}@keyframes gradient-animation{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}.pulsate-animation{animation:pulsate 2s infinite}.preview-item:hover{transform:scale(1.03);background-color:var(--bg-secondary)}.animate-delete{transition:opacity .3s ease,transform .3s ease,max-height .3s ease .1s,padding .3s ease .1s,margin .3s ease .1s;opacity:0;transform:scale(.9);max-height:0!important;padding-top:0!important;padding-bottom:0!important;margin-top:0!important;margin-bottom:0!important;overflow:hidden}</style></head><body><div id="app" class="container"><header class="main-header animate-fade-in-up"><h1 class="main-title">Статистика Сделок</h1><div class="flex items-center gap-4"><button id="settings-btn" class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div></header><div id="header-actions" class="flex flex-col sm:flex-row justify-start space-y-4 sm:space-y-0 sm:space-x-4 mb-8 animate-fade-in-up" style="animation-delay:100ms"><button id="create-statistic-btn" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg> Создать Статистику</button><button id="add-trade-btn" class="btn btn-secondary">Добавить Сделку</button></div><div id="statistics-overview"><div id="statistics-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div id="no-statistics-message" class="text-center text-gray-500 text-xl mt-16 hidden"><p class="animate-fade-in-up">Пока нет созданных статистик. Начните с создания новой!</p></div></div><div id="trade-detail-view" class="hidden"><button id="back-to-stats-btn" class="btn btn-secondary mb-6"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg> Назад</button><h2 id="detail-statistic-name" class="text-3xl font-bold mb-6"></h2><div class="flex flex-wrap gap-4 mb-6"><button id="copy-current-statistic-btn" class="btn btn-secondary">Копировать</button><button id="show-results-btn" class="btn btn-secondary">Результаты</button></div><div id="trade-list" class="space-y-4"></div><div id="no-trades-message" class="text-center text-gray-500 text-xl mt-16 hidden"><p>В этой статистике пока нет сделок.</p></div></div></div><div id="create-statistic-modal" class="modal-overlay"><div class="modal-content"><button class="close-button" data-modal-id="create-statistic-modal">&times;</button><h2 id="create-statistic-modal-title" class="modal-title">Создать Статистику</h2><form id="create-statistic-form"><div class="form-group"><label for="statistic-name" class="form-label">Название Статистики</label><input type="text" id="statistic-name" class="form-input" placeholder="Например: Мои Сделки" required></div><button type="submit" id="create-statistic-submit-btn" class="btn btn-primary w-full">Создать</button></form></div></div><div id="add-trade-modal" class="modal-overlay"><div class="modal-content" style="max-width:850px"><button class="close-button" data-modal-id="add-trade-modal">&times;</button><h2 id="add-trade-modal-title" class="modal-title">Добавить Сделку</h2><div class="grid md:grid-cols-2 gap-x-8"><form id="add-trade-form" class="space-y-4"><div class="form-group" id="select-statistic-container"><label for="select-statistic" class="form-label">Статистика</label><select id="select-statistic" class="form-select" required></select></div><div class="form-group"><label for="coin-name" class="form-label">Монета</label><input type="text" id="coin-name" class="form-input" placeholder="Например: BTC/USDT" required></div><div class="grid grid-cols-2 gap-4"><div class="form-group"><label for="entry-price" class="form-label">Точка входа</label><input type="number" step="any" id="entry-price" class="form-input" required></div><div class="form-group"><label for="margin" class="form-label">Маржа (X)</label><input type="number" step="any" id="margin" class="form-input" required></div></div><div class="form-group"><label class="form-label">Направление</label><div id="direction-selector" class="flex rounded-lg border border-[var(--border-color)] p-1 space-x-1"><button type="button" data-value="long" class="direction-btn">LONG</button><button type="button" data-value="short" class="direction-btn">SHORT</button></div><input type="hidden" id="direction-hidden-input" name="direction"></div><div class="form-group"><label class="form-label">Фиксации</label><div id="fixations-container" class="space-y-2"></div><p id="fixation-total-warning" class="text-red-500 text-sm mt-2 hidden">Общий процент фиксаций не может превышать 100%.</p></div><button type="submit" id="add-trade-submit-btn" class="btn btn-primary w-full mt-4">Добавить</button></form><div id="trade-preview-pane" class="bg-[var(--bg-primary)] p-6 rounded-2xl border border-[var(--border-color)] flex flex-col"><h3 class="text-lg font-bold mb-4 text-[var(--text-primary)] flex-shrink-0">Предпросмотр</h3><div id="preview-content" class="space-y-3 flex-grow"></div><div id="preview-placeholder" class="text-center text-[var(--text-secondary)] m-auto"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg><p>Введите данные в форму, чтобы увидеть результат.</p></div></div></div></div></div><div id="confirmation-modal" class="modal-overlay"><div class="modal-content text-center"><h3 id="confirmation-message" class="text-xl font-semibold mb-6">Вы уверены?</h3><div class="flex justify-center gap-4"><button id="confirm-yes-btn" class="btn bg-red-600 text-white hover:bg-red-700">Да</button><button id="confirm-no-btn" class="btn btn-secondary">Отмена</button></div></div></div><div id="results-modal" class="modal-overlay"><div class="modal-content"><button class="close-button" data-modal-id="results-modal">&times;</button><h2 class="modal-title">Результаты</h2><div id="results-content" class="space-y-3 text-lg text-center"></div></div></div><div id="settings-panel" class="settings-panel"><div class="settings-header"><h3 class="settings-title">Настройки</h3><button id="close-settings-btn" class="close-button">&times;</button></div><div class="space-y-6"><div class="form-group"><label class="form-label flex justify-between items-center"><span>Темная тема</span><label class="toggle-switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></label></div><div class="form-group"><label class="form-label flex justify-between items-center"><span>Отключить анимации</span><label class="toggle-switch"><input type="checkbox" id="animations-toggle"><span class="slider"></span></label></label></div><div class="form-group"><label for="sort-trades-by" class="form-label">Сортировать сделки по</label><select id="sort-trades-by" class="form-select"><option value="date_desc">Сначала новые</option><option value="date_asc">Сначала старые</option><option value="profit_desc">Самые прибыльные</option><option value="profit_asc">Самые убыточные</option></select></div><div class="form-group"><label for="default-margin" class="form-label">Маржа по умолчанию</label><input type="number" id="default-margin" class="form-input" placeholder="1"></div><div class="space-y-3"><button id="export-data-btn" class="btn btn-secondary w-full">Экспорт данных</button><button id="import-data-btn" class="btn btn-secondary w-full">Импорт данных</button><input type="file" id="import-file-input" class="hidden" accept=".json"></div><div class="border-t border-dashed pt-6 mt-6 space-y-3 border-red-500/50"><button id="delete-all-stats-btn" class="btn bg-red-600/10 text-red-500 hover:bg-red-600/20 w-full">Удалить все статистики</button><button id="clear-memory-btn" class="btn bg-red-600/10 text-red-500 hover:bg-red-600/20 w-full">Очистить память</button></div></div></div><div id="toast"></div><script>document.addEventListener("DOMContentLoaded",(()=>{let e={},t=null,i=null,n=null,s=null,a=!1,o={};const d=t=>document.querySelector(t),l=t=>document.querySelectorAll(t),c={init(){this.loadSettings(),this.applySettings(),this.loadData(),this.attachEventListeners(),this.renderStatisticsList(),t&&e[t]?(this.renderTradeDetail(t),localStorage.setItem("currentStatisticId",t)):(d("#trade-detail-view").classList.add("hidden"),d("#statistics-overview").classList.remove("hidden"))},attachEventListeners(){d("#create-statistic-btn").addEventListener("click",()=>this.openModal("create-statistic-modal")),d("#add-trade-btn").addEventListener("click",()=>this.handleAddTradeClick()),d("#back-to-stats-btn").addEventListener("click",()=>this.showStatisticsOverview()),d("#create-statistic-form").addEventListener("submit",e=>this.handleStatisticFormSubmit(e)),d("#add-trade-form").addEventListener("submit",e=>this.handleTradeFormSubmit(e)),d("#confirm-yes-btn").addEventListener("click",()=>this.handleConfirmYes()),d("#confirm-no-btn").addEventListener("click",()=>this.closeModal("confirmation-modal")),d("#copy-current-statistic-btn").addEventListener("click",()=>this.copyCurrentStatistic()),d("#show-results-btn").addEventListener("click",()=>this.showResults(t)),d("#settings-btn").addEventListener("click",()=>d("#settings-panel").classList.add("active")),d("#close-settings-btn").addEventListener("click",()=>d("#settings-panel").classList.remove("active")),d("#theme-toggle").addEventListener("change",e=>this.updateSetting("theme",e.target.checked?"dark":"light")),d("#animations-toggle").addEventListener("change",e=>this.updateSetting("animationsDisabled",e.target.checked)),d("#sort-trades-by").addEventListener("change",e=>this.updateSetting("sortTradesBy",e.target.value)),d("#default-margin").addEventListener("input",e=>this.updateSetting("defaultMargin",e.target.value)),d("#export-data-btn").addEventListener("click",()=>this.exportData()),d("#import-data-btn").addEventListener("click",()=>d("#import-file-input").click()),d("#import-file-input").addEventListener("change",e=>this.importData(e)),d("#delete-all-stats-btn").addEventListener("click",()=>this.confirmAction("Вы уверены, что хотите удалить ВСЕ статистики?",()=>this.deleteAllStatistics())),d("#clear-memory-btn").addEventListener("click",()=>this.confirmAction("Это действие удалит ВСЕ данные приложения. Продолжить?",()=>this.clearMemory())),d("#add-trade-form").addEventListener("input",()=>this.updateTradePreview()),document.body.addEventListener("click",s=>{if(s.target.classList.contains("modal-overlay")&&this.closeAllModals(),d("#settings-panel").classList.contains("active")&&!d("#settings-panel").contains(s.target)&&!s.target.closest("#settings-btn")&&d("#settings-panel").classList.remove("active"),s.target.classList.contains("close-button")&&this.closeModal(s.target.dataset.modalId),s.target.closest(".statistic-card")){const a=s.target.closest(".statistic-card"),o=a.dataset.id;s.target.closest(".edit-statistic-name-btn")?this.editStatisticName(o):s.target.closest(".delete-statistic-btn")?this.confirmAction("Удалить эту статистику и все ее сделки?",()=>this.deleteStatistic(o,a)):(t=o,this.renderTradeDetail(o))}s.target.closest(".add-fixation-btn")&&this.addFixationField(),s.target.closest(".remove-fixation-btn")&&this.removeFixationField(s.target.closest(".remove-fixation-btn")),s.target.closest(".copy-trade-single-btn")&&this.copySingleTrade(s.target.closest(".copy-trade-single-btn").dataset.tradeId),s.target.closest(".edit-trade-btn")&&this.editTrade(t,s.target.closest(".edit-trade-btn").dataset.tradeId),s.target.closest(".delete-trade-btn")&&this.confirmAction("Удалить эту сделку?",()=>{const e=s.target.closest(".delete-trade-btn").dataset.tradeId,i=s.target.closest(".trade-card");this.deleteTrade(t,e,i)}),s.target.matches(".direction-btn")&&(this.handleDirectionSelection(s.target),this.updateTradePreview())}),document.body.addEventListener("change",e=>{if(e.target.classList.contains("trade-date-input")){const i=e.target.closest(".trade-card").dataset.tradeId;this.updateTradeDate(t,i,e.target.value)}"select-statistic"===e.target.id&&this.updateTradePreview()}),document.body.addEventListener("keydown",e=>{d("#add-trade-modal").classList.contains("active")&&"ArrowDown"===e.key&&(e.preventDefault(),d("#select-statistic").focus())})},loadSettings(){const e=localStorage.getItem("tradeStatisticsSettings"),t={theme:"dark",animationsDisabled:!1,sortTradesBy:"date_desc",defaultMargin:1};o=e?JSON.parse(e):t},saveSettings(){localStorage.setItem("tradeStatisticsSettings",JSON.stringify(o))},updateSetting(e,i){o[e]=i,this.saveSettings(),this.applySettings(),"sortTradesBy"===e&&t&&this.renderTradeDetail(t)},applySettings(){document.documentElement.setAttribute("data-theme",o.theme),d("#theme-toggle").checked="dark"===o.theme,document.body.classList.toggle("animations-disabled",o.animationsDisabled),d("#animations-toggle").checked=o.animationsDisabled,d("#sort-trades-by").value=o.sortTradesBy,d("#default-margin").value=o.defaultMargin},loadData(){const i=localStorage.getItem("tradeStatistics");i&&(e=JSON.parse(i));const n=localStorage.getItem("currentStatisticId");n&&e[n]&&(t=n)},saveData(){localStorage.setItem("tradeStatistics",JSON.stringify(e)),t?localStorage.setItem("currentStatisticId",t):localStorage.removeItem("currentStatisticId")},renderStatisticsList(){const t=d("#statistics-list");t.innerHTML="";const i=Object.keys(e);d("#add-trade-btn").style.display=i.length>0?"inline-flex":"none",d("#no-statistics-message").classList.toggle("hidden",i.length>0),t.classList.toggle("hidden",0===i.length),0===i.length?d("#create-statistic-btn").classList.add("pulsate-animation"):d("#create-statistic-btn").classList.remove("pulsate-animation"),i.forEach(((i,n)=>{const s=e[i],a=this.calculateStatisticMetrics(i),o=a.winRate>50?"color-green":a.winRate<50?"color-red":"color-gray",d=a.totalNetMovement>0?"color-green":a.totalNetMovement<0?"color-red":"color-gray",l=document.createElement("div");l.className="statistic-card",l.dataset.id=i,l.style.animationDelay=`${70*n}ms`,l.innerHTML=`\n                            <div class="flex justify-between items-start mb-4">\n                                <h3 class="text-xl font-bold pr-2">${s.name}</h3>\n                                <div class="flex-shrink-0 flex gap-1">\n                                    <button class="edit-statistic-name-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)]" title="Редактировать"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button>\n                                    <button class="delete-statistic-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)] text-red-500" title="Удалить"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>\n                                </div>\n                            </div>\n                            <div class="text-sm text-[var(--text-secondary)] mb-4">Всего сделок: ${a.totalTrades}</div>\n                            <div class="flex justify-between items-end text-sm">\n                                <div>\n                                    <div class="text-[var(--text-secondary)]">Винрейт</div>\n                                    <div class="font-bold text-lg ${o}">${a.winRate.toFixed(2)}%</div>\n                                </div>\n                                <div>\n                                    <div class="text-[var(--text-secondary)]">Чистое движение</div>\n                                    <div class="font-bold text-lg ${d}">${a.totalNetMovement.toFixed(2)}%</div>\n                                </div>\n                            </div>`,t.appendChild(l),l.classList.add("animate-fade-in-up")}))},renderTradeDetail(i){d("#statistics-overview").classList.add("hidden"),d("#trade-detail-view").classList.remove("hidden");const n=e[i];if(d("#detail-statistic-name").textContent=n.name,t=i,this.saveData(),!n.trades||0===n.trades.length)return void d("#no-trades-message").classList.remove("hidden");d("#no-trades-message").classList.add("hidden");const s=d("#trade-list");s.innerHTML="";this.sortTrades([...n.trades]).forEach(((e,t)=>{const i=this.calculateTradeMetrics(e);e.netMovement=i.netMovement;const n=e.netMovement>0?"profit-loss-green":e.netMovement<0?"profit-loss-red":"profit-loss-gray",a=e.fixations.map(e=>`${e.price} (${e.percent}%)`).join(" "),o="long"===e.direction?'<span class="color-green">long</span>':'<span class="color-red">short</span>',d=e.date?new Date(e.date).toISOString().split("T")[0]:"",l=document.createElement("div");l.className="trade-card animate-slide-in-left",l.dataset.tradeId=e.id,l.style.animationDelay=`${60*t}ms`,l.innerHTML=`\n                            <div class="flex justify-between items-start gap-4">\n                                <div>\n                                    <h4 class="text-lg font-semibold">${e.coin} (${o})</h4>\n                                    <div class="text-sm text-[var(--text-secondary)] mt-1">\n                                        ENTRY: ${e.entry} &bull; Маржа: X${e.margin}\n                                    </div>\n                                </div>\n                                <span class="px-3 py-1 rounded-full text-sm font-bold ${n} flex-shrink-0">\n                                    ${e.netMovement.toFixed(2)}%\n                                </span>\n                            </div>\n                            <div class="text-sm text-[var(--text-secondary)] mt-3">Фиксации: ${a}</div>\n                            <div class="flex justify-between items-center mt-4">\n                                 <input type="date" value="${d}" class="trade-date-input bg-transparent border-none p-0 text-[var(--text-secondary)]" title="Изменить дату">\n                                 <div class="flex gap-1">\n                                    <button class="copy-trade-single-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)]" data-trade-id="${e.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button>\n                                    <button class="delete-trade-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)] text-red-500" data-trade-id="${e.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>\n                                 </div>\n                            </div>`,l.addEventListener("click",t=>{t.target.closest("button")||t.target.closest("input")||this.copySingleTrade(e.id)}),s.appendChild(l)}))},sortTrades(e){const t=o.sortTradesBy;return e.sort(((e,i)=>{const n=e.timestamp||0,s=i.timestamp||0,a=e.netMovement||0,o=i.netMovement||0;switch(t){case"date_asc":return n-s;case"profit_desc":return o-a;case"profit_asc":return a-o;case"date_desc":default:return s-n}}))},calculateTradeMetrics(e){let t=0;e.fixations&&e.fixations.length>0&&e.fixations.forEach((i=>{const n=parseFloat(i.price),s=parseFloat(i.percent);if(isNaN(n)||isNaN(s)||0===s||!e.entry)return;const a=parseFloat(e.entry);let o="long"===e.direction?(n-a)/a:(a-n)/a;t+=o*s/100}));return{netMovement:100*t*parseFloat(e.margin||1)}},calculateStatisticMetrics(t){const i=e[t];if(!i||!i.trades||0===i.trades.length)return{totalTrades:0,profitableTrades:0,rejectedTrades:0,breakevenTrades:0,winRate:0,totalNetMovement:0};let n=0,s=0,a=0,o=0;return i.trades.forEach((e=>{const t=this.calculateTradeMetrics(e);e.netMovement=t.netMovement,e.netMovement>0?n++:e.netMovement<0?s++:a++,o+=e.netMovement})),{totalTrades:i.trades.length,profitableTrades:n,rejectedTrades:s,breakevenTrades:a,winRate:i.trades.length-a>0?n/(i.trades.length-a)*100:0,totalNetMovement:o}},openModal(e){const t=d("#"+e);t&&(t.classList.add("active"),"add-trade-modal"===e&&(this.resetAddTradeForm(),this.updateTradePreview(),setTimeout((()=>d("#trade-preview-pane").classList.add("animate-slide-in-right")),10)))},closeModal(e){d("#"+e)?.classList.remove("active")},closeAllModals(){l(".modal-overlay").forEach(e=>e.classList.remove("active"))},showToast(e){const t=d("#toast");t.textContent=e,t.classList.add("show"),setTimeout((()=>t.classList.remove("show")),3e3)},confirmAction(e,t){d("#confirmation-message").textContent=e,s=t,this.openModal("confirmation-modal")},handleConfirmYes(){s&&s(),this.closeModal("confirmation-modal")},handleStatisticFormSubmit(t){t.preventDefault();const i=d("#statistic-name").value.trim();if(!i)return;let s=null;n?(e[n].name=i,n=null):s=`stat-${crypto.randomUUID()}`,e[s]={name:i,trades:[]},this.saveData(),this.renderStatisticsList(),this.closeModal("create-statistic-modal"),a&&s&&(this.populateStatisticSelect(s),this.openModal("add-trade-modal"),a=!1)},handleTradeFormSubmit(s){s.preventDefault();const a=d("#select-statistic").value,o=d("#coin-name").value.trim().toUpperCase(),c=d("#direction-hidden-input").value,r=parseFloat(d("#entry-price").value),m=parseFloat(d("#margin").value);let u=[],h=0;if(l("#fixations-container .flex").forEach((e=>{const t=parseFloat(e.querySelector(".fixation-price").value),i=parseFloat(e.querySelector(".fixation-percent").value);isNaN(t)||isNaN(i)||(u.push({price:t,percent:i}),h+=i)})),h>100.001)return void d("#fixation-total-warning").classList.remove("hidden");d("#fixation-total-warning").classList.add("hidden");const p=i?t:a;if(!p||!o||isNaN(r)||isNaN(m)||!c)return;if(i){const s=e[t].trades.findIndex(e=>e.id===i.id);-1!==s&&Object.assign(e[t].trades[s],{coin:o,direction:c,entry:r,fixations:u,margin:m,timestamp:e[t].trades[s].timestamp})}else{const i={id:`trade-${crypto.randomUUID()}`,coin:o,direction:c,entry:r,fixations:u,margin:m,date:(new Date).toISOString(),timestamp:Date.now()};e[p].trades.push(i)}this.saveData(),this.renderStatisticsList(),this.closeModal("add-trade-modal"),t===p&&this.renderTradeDetail(t)},handleAddTradeClick(){const t=Object.keys(e);if(0===t.length)return a=!0,void this.openModal("create-statistic-modal");const i=t.reduce(((t,i)=>e[t].trades.length>=e[i].trades.length?t:i));this.populateStatisticSelect(i),this.openModal("add-trade-modal")},showStatisticsOverview(){d("#trade-detail-view").classList.add("hidden"),d("#statistics-overview").classList.remove("hidden"),t=null,this.saveData(),this.renderStatisticsList()},editStatisticName(t){n=t;const i=e[t];d("#create-statistic-modal-title").textContent="Редактировать Статистику",d("#create-statistic-submit-btn").textContent="Обновить",d("#statistic-name").value=i.name,this.openModal("create-statistic-modal")},deleteStatistic(i,n){n.classList.add("animate-delete"),setTimeout((()=>{delete e[i],t===i&&(t=null),this.saveData(),this.showStatisticsOverview()}),400)},editTrade(n,s){i=e[n].trades.find(e=>e.id===s),i&&(d("#add-trade-modal-title").textContent="Редактировать Сделку",d("#add-trade-submit-btn").textContent="Обновить",d("#select-statistic-container").classList.add("hidden"),d("#coin-name").value=i.coin,this.setDirectionSelector(i.direction),d("#entry-price").value=i.entry,d("#margin").value=i.margin,d("#fixations-container").innerHTML="",i.fixations.forEach(e=>this.addFixationField(e.price,e.percent)),0===i.fixations.length&&this.addFixationField(),this.openModal("add-trade-modal"))},deleteTrade(t,i,n){n.classList.add("animate-delete"),setTimeout((()=>{const n=e[t];n&&(n.trades=n.trades.filter(e=>e.id!==i),this.saveData(),this.renderTradeDetail(t),this.renderStatisticsList())}),400)},updateTradeDate(i,n,s){const a=e[i]?.trades.find(e=>e.id===n);a&&(a.date=s?new Date(s).toISOString():null,a.timestamp=s?(new Date(s)).getTime():Date.now(),this.saveData(),this.renderTradeDetail(t))},resetAddTradeForm(){d("#add-trade-form").reset(),d("#add-trade-modal-title").textContent="Добавить Сделку",d("#add-trade-submit-btn").textContent="Добавить",d("#select-statistic-container").classList.remove("hidden"),d("#fixations-container").innerHTML="",this.addFixationField(),d("#margin").value=o.defaultMargin,this.setDirectionSelector("long"),i=null,this.updateTradePreview()},addFixationField(e="",t=""){const i=d("#fixations-container"),n=0===i.children.length,s=document.createElement("div");s.className="flex items-center gap-2 animate-fade-in-up",s.style.animationDuration="0.3s",s.innerHTML=`\n                        <input type="number" step="any" class="fixation-price form-input" placeholder="Цена" value="${e}">\n                        <input type="number" step="any" min="0" max="100" class="fixation-percent form-input" placeholder="%" value="${t}">\n                        <button type="button" class="${n?"add-fixation-btn text-green-500":"remove-fixation-btn text-red-500"} p-2 rounded-md hover:bg-[var(--gray-bg)] transition-transform hover:scale-110">\n                            ${n?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>'}\n                        </button>\n                    `,i.appendChild(s)},removeFixationField(e){const t=e.closest(".flex");t.classList.add("animate-delete"),setTimeout((()=>t.remove()),400)},handleDirectionSelection(e){this.setDirectionSelector(e.dataset.value)},setDirectionSelector(e){d("#direction-hidden-input").value=e,l(".direction-btn").forEach(e=>{e.classList.remove("selected-long","selected-short")});const t=d(`.direction-btn[data-value="${e}"]`);t&&t.classList.add("long"===e?"selected-long":"selected-short")},updateTradePreview(){const t=d("#add-trade-form"),i=d("#preview-content"),n=d("#preview-placeholder"),s=t.querySelector("#coin-name").value.trim().toUpperCase(),a=t.querySelector("#direction-hidden-input").value,l=parseFloat(t.querySelector("#entry-price").value),c=parseFloat(t.querySelector("#margin").value),r=t.querySelector("#select-statistic").value,m=r&&e[r]?e[r].name:"Не выбрана";let u=[];if(t.querySelectorAll("#fixations-container .flex").forEach((e=>{const t=parseFloat(e.querySelector(".fixation-price").value),i=parseFloat(e.querySelector(".fixation-percent").value);isNaN(t)||isNaN(i)||i<=0||u.push({price:t,percent:i})})),!s&&isNaN(l))return i.innerHTML="",void n.classList.remove("hidden");n.classList.add("hidden");const h=this.calculateTradeMetrics({entry:l,margin:isNaN(c)?o.defaultMargin:c,direction:a,fixations:u}).netMovement,p=h>0?"color-green":h<0?"color-red":"color-gray",g="long"===a?'<span class="color-green font-semibold">LONG</span>':'<span class="color-red font-semibold">SHORT</span>';i.innerHTML=`\n                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">\n                            <div class="text-sm text-[var(--text-secondary)]">Монета</div>\n                            <div class="text-xl font-bold">${s||"..."}</div>\n                        </div>\n                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">\n                            <div class="text-sm text-[var(--text-secondary)]">Направление</div>\n                            <div class="text-xl">${g}</div>\n                        </div>\n                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">\n                            <div class="text-sm text-[var(--text-secondary)]">Чистое движение</div>\n                            <div class="text-2xl font-bold ${p}">${isNaN(h)?"0.00":h.toFixed(2)}%</div>\n                        </div>\n                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">\n                            <div class="text-sm text-[var(--text-secondary)]">Маржа</div>\n                            <div class="text-xl font-bold">X${isNaN(c)?o.defaultMargin:c}</div>\n                        </div>\n                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">\n                            <div class="text-sm text-[var(--text-secondary)]">Статистика</div>\n                            <div class="text-lg font-semibold truncate" title="${m}">${m}</div>\n                        </div>\n                    `},populateStatisticSelect(t=null){const i=d("#select-statistic");i.innerHTML='<option value="">-- Выберите статистику --</option>',Object.keys(e).forEach((t=>{const n=document.createElement("option");n.value=t,n.textContent=e[t].name,i.appendChild(n)})),t&&(i.value=t)},copyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy"),this.showToast("Скопировано в буфер обмена!")}catch(e){this.showToast("Ошибка при копировании")}finally{document.body.removeChild(t)}},generateSingleTradeExportText(e){const t="long"===e.direction?"long":"short",i=e.fixations.map(e=>`${e.price} (${e.percent}%)`).join(" "),n=e.date?(new Date(e.date)).toLocaleDateString("ru-RU"):"Нет даты",s=this.calculateTradeMetrics(e);return`${e.coin} (${t})\nЧистое движение: ${s.netMovement.toFixed(2)}%\nENTRY: ${e.entry}\nМаржа: X${e.margin}\nФиксации: ${i}\nДата: ${n}`},copySingleTrade(i){const n=e[t].trades.find(e=>e.id===i);n&&this.copyToClipboard(this.generateSingleTradeExportText(n))},copyCurrentStatistic(){let t=`--- Статистика: ${e[currentStatisticId].name} ---\n\n`;this.sortTrades([...e[currentStatisticId].trades]).forEach((e=>{t+=this.generateSingleTradeExportText(e)+"\n\n"})),this.copyToClipboard(t.trim())},animateCountUp(e,t,i=800,n=!1){if(!e)return;let s=null;const a=0,o=parseFloat(t);if(isNaN(o))return;const d=t=>{s||(s=t);const l=Math.min((t-s)/i,1),c=l*(o-a)+a;n?e.textContent=`${c.toFixed(2)}%`:e.textContent=Math.floor(c),l<1?window.requestAnimationFrame(d):n?e.textContent=`${o.toFixed(2)}%`:e.textContent=Math.round(o)};window.requestAnimationFrame(d)},showResults(e){const t=this.calculateStatisticMetrics(e),i=d("#results-content");i.innerHTML=`\n                        <p>Чистое движение: <span id="res-net" class="font-bold ${t.totalNetMovement>0?"color-green":t.totalNetMovement<0?"color-red":"color-gray"}">0.00%</span></p>\n                        <p>Винрейт: <span id="res-winrate" class="font-bold ${t.winRate>50?"color-green":t.winRate<50?"color-red":"color-gray"}">0.00%</span></p>\n                        <p>Всего сделок: <span id="res-total" class="font-bold">0</span></p>\n                        <p>Успешных: <span id="res-profit" class="font-bold color-green">0</span></p>\n                        <p>Убыточных: <span id="res-loss" class="font-bold color-red">0</span></p>\n                        <p>В безубыток: <span id="res-be" class="font-bold color-gray">0</span></p>\n                    `,this.openModal("results-modal"),this.animateCountUp(d("#res-net"),t.totalNetMovement,800,!0),this.animateCountUp(d("#res-winrate"),t.winRate,800,!0),this.animateCountUp(d("#res-total"),t.totalTrades),this.animateCountUp(d("#res-profit"),t.profitableTrades),this.animateCountUp(d("#res-loss"),t.rejectedTrades),this.animateCountUp(d("#res-be"),t.breakevenTrades)},deleteAllStatistics(){e={},this.saveData(),this.renderStatisticsList(),this.showStatisticsOverview()},clearMemory(){localStorage.clear(),window.location.reload()},exportData(){const t=JSON.stringify({statistics:e,settings:o},null,2),i="data:application/json;charset=utf-8,"+encodeURIComponent(t),n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download","trade_stats_backup.json"),n.click()},importData(t){const i=t.target.files[0];if(!i)return;const n=new FileReader;n.onload=t=>{try{const i=JSON.parse(t.target.result);i.statistics&&i.settings?(e=i.statistics,o=i.settings,this.saveData(),this.saveSettings(),this.applySettings(),this.renderStatisticsList(),this.showStatisticsOverview(),this.showToast("Данные успешно импортированы!")):this.showToast("Ошибка: неверный формат файла.")}catch(e){this.showToast("Ошибка при чтении файла.")}},n.readAsText(i),t.target.value=""}};c.init()}));</script></body></html>


