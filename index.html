<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Счетчик Статистики Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://i.ibb.co/2Yg0Wn4/favicon.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-primary-light: #f4f7fe;
            --bg-secondary-light: #ffffff;
            --text-primary-light: #111827;
            --text-secondary-light: #4b5563;
            --border-light: #e5e7eb;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --accent-gradient: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            --success-light: #10b981;
            --danger-light: #ef4444;
            --success-bg-light: #f0fdf4;
            --danger-bg-light: #fef2f2;
            --success-border-light: #a7f3d0;
            --danger-border-light: #fecaca;
            --gray-bg-light: #f3f4f6;

            --bg-primary-dark: #111827;
            --bg-secondary-dark: #1f2937;
            --text-primary-dark: #f9fafb;
            --text-secondary-dark: #9ca3af;
            --border-dark: #374151;
            --success-dark: #34d399;
            --danger-dark: #f87171;
            --success-bg-dark: #052e16;
            --danger-bg-dark: #450a0a;
            --success-border-dark: #15803d;
            --danger-border-dark: #b91c1c;
            --gray-bg-dark: #374151;
        }

        [data-theme="light"] {
            --bg-primary: var(--bg-primary-light);
            --bg-secondary: var(--bg-secondary-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-light);
            --success-color: var(--success-light);
            --danger-color: var(--danger-light);
            --success-bg: var(--success-bg-light);
            --danger-bg: var(--danger-bg-light);
            --success-border: var(--success-border-light);
            --danger-border: var(--danger-border-light);
            --gray-bg: var(--gray-bg-light);
        }

        [data-theme="dark"] {
            --bg-primary: var(--bg-primary-dark);
            --bg-secondary: var(--bg-secondary-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --success-color: var(--success-dark);
            --danger-color: var(--danger-dark);
            --success-bg: var(--success-bg-dark);
            --danger-bg: var(--danger-bg-dark);
            --success-border: var(--success-border-dark);
            --danger-border: var(--danger-border-dark);
            --gray-bg: var(--gray-bg-dark);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body.animations-disabled *,
        body.animations-disabled *::before,
        body.animations-disabled *::after {
             animation: none !important;
             transition: none !important;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1rem;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .main-title {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--text-primary);
            animation: text-focus-in 1s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background-image: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 50%, var(--accent-primary) 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px -5px rgba(79, 70, 229, 0.6);
            animation: gradient-animation 4s ease infinite;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.5);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
             background-color: var(--gray-bg);
             transform: translateY(-2px);
        }
        
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.6rem;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-icon:hover {
            background: var(--gray-bg);
            color: var(--accent-primary);
            transform: rotate(15deg) scale(1.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .modal-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
            text-align: center;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 99px;
            line-height: 1;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .close-button:hover {
            background-color: var(--gray-bg);
            transform: scale(1.1);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        
        .statistic-card {
            background-color: var(--bg-secondary);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            opacity: 0;
        }
        .statistic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
        }
        
        .trade-card {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            opacity: 0;
        }
        .trade-card:hover {
            background-color: var(--bg-primary);
            transform: translateY(-5px);
        }

        .profit-loss-green { background-color: var(--success-bg); color: var(--success-color); }
        .profit-loss-red { background-color: var(--danger-bg); color: var(--danger-color); }
        .profit-loss-gray { background-color: var(--gray-bg); color: var(--text-secondary); }

        .color-green { color: var(--success-color); }
        .color-red { color: var(--danger-color); }
        .color-gray { color: var(--text-secondary); }
        
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 500;
        }
        #toast.show {
            bottom: 30px;
            transform: translateX(-50%) scale(1);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 100%;
            max-width: 350px;
            height: 100%;
            background-color: var(--bg-secondary);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 1100;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 1.5rem;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
        }
        .settings-panel.active {
            right: 0;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .settings-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-primary);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        .direction-btn {
            transition: all 0.2s ease-in-out;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border: 2px solid transparent;
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .direction-btn.selected-long {
            background-color: var(--success-bg);
            color: var(--success-color);
            border-color: var(--success-border);
            box-shadow: 0 0 15px -5px var(--success-bg);
        }
        .direction-btn.selected-short {
            background-color: var(--danger-bg);
            color: var(--danger-color);
            border-color: var(--danger-border);
            box-shadow: 0 0 15px -5px var(--danger-bg);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in-right { animation: slideInRight 0.5s ease-out forwards; }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in-left { animation: slideInLeft 0.5s ease-out forwards; }
        
        @keyframes text-focus-in {
            0% { filter: blur(12px); opacity: 0; }
            100% { filter: blur(0px); opacity: 1; }
        }
        
        @keyframes pulsate {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 10px 10px rgba(79, 70, 229, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .pulsate-animation { animation: pulsate 2s infinite; }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .preview-item:hover {
            transform: scale(1.03);
            background-color: var(--bg-secondary);
        }
        
        .animate-delete {
            transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease 0.1s, padding 0.3s ease 0.1s, margin 0.3s ease 0.1s;
            opacity: 0;
            transform: scale(0.9);
            max-height: 0px !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <header class="main-header animate-fade-in-up">
            <h1 class="main-title">Статистика Сделок</h1>
            <div class="flex items-center gap-4">
                 <button id="settings-btn" class="btn-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
            </div>
        </header>

        <div id="header-actions" class="flex flex-col sm:flex-row justify-start space-y-4 sm:space-y-0 sm:space-x-4 mb-8 animate-fade-in-up" style="animation-delay: 100ms;">
            <button id="create-statistic-btn" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                Создать Статистику
            </button>
            <button id="add-trade-btn" class="btn btn-secondary">
                Добавить Сделку
            </button>
        </div>

        <div id="statistics-overview">
            <div id="statistics-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="no-statistics-message" class="text-center text-gray-500 text-xl mt-16 hidden">
                <p class="animate-fade-in-up">Пока нет созданных статистик. Начните с создания новой!</p>
            </div>
        </div>

        <div id="trade-detail-view" class="hidden">
            <button id="back-to-stats-btn" class="btn btn-secondary mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
                Назад
            </button>
            <h2 id="detail-statistic-name" class="text-3xl font-bold mb-6"></h2>
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="copy-current-statistic-btn" class="btn btn-secondary">Копировать</button>
                <button id="show-results-btn" class="btn btn-secondary">Результаты</button>
            </div>
            <div id="trade-list" class="space-y-4"></div>
            <div id="no-trades-message" class="text-center text-gray-500 text-xl mt-16 hidden">
                <p>В этой статистике пока нет сделок.</p>
            </div>
        </div>
    </div>

    <div id="create-statistic-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" data-modal-id="create-statistic-modal">&times;</button>
            <h2 id="create-statistic-modal-title" class="modal-title">Создать Статистику</h2>
            <form id="create-statistic-form">
                <div class="form-group">
                    <label for="statistic-name" class="form-label">Название Статистики</label>
                    <input type="text" id="statistic-name" class="form-input" placeholder="Например: Мои Сделки" required>
                </div>
                <button type="submit" id="create-statistic-submit-btn" class="btn btn-primary w-full">Создать</button>
            </form>
        </div>
    </div>

    <div id="add-trade-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 850px;">
            <button class="close-button" data-modal-id="add-trade-modal">&times;</button>
            <h2 id="add-trade-modal-title" class="modal-title">Добавить Сделку</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                <form id="add-trade-form" class="space-y-4">
                    <div class="form-group" id="select-statistic-container">
                        <label for="select-statistic" class="form-label">Статистика</label>
                        <select id="select-statistic" class="form-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="coin-name" class="form-label">Монета</label>
                        <input type="text" id="coin-name" class="form-input" placeholder="Например: BTC/USDT" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="entry-price" class="form-label">Точка входа</label>
                            <input type="number" step="any" id="entry-price" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="margin" class="form-label">Маржа (X)</label>
                            <input type="number" step="any" id="margin" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Направление</label>
                        <div id="direction-selector" class="flex rounded-lg border border-[var(--border-color)] p-1 space-x-1">
                            <button type="button" data-value="long" class="direction-btn">LONG</button>
                            <button type="button" data-value="short" class="direction-btn">SHORT</button>
                        </div>
                        <input type="hidden" id="direction-hidden-input" name="direction">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Фиксации</label>
                        <div id="fixations-container" class="space-y-2"></div>
                        <p id="fixation-total-warning" class="text-red-500 text-sm mt-2 hidden">Общий процент фиксаций не может превышать 100%.</p>
                    </div>
                    <button type="submit" id="add-trade-submit-btn" class="btn btn-primary w-full mt-4">Добавить</button>
                </form>
                <div id="trade-preview-pane" class="bg-[var(--bg-primary)] p-6 rounded-2xl border border-[var(--border-color)] flex flex-col">
                    <h3 class="text-lg font-bold mb-4 text-[var(--text-primary)] flex-shrink-0">Предпросмотр</h3>
                    <div id="preview-content" class="space-y-3 flex-grow">
                    </div>
                    <div id="preview-placeholder" class="text-center text-[var(--text-secondary)] m-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <p>Введите данные в форму, чтобы увидеть результат.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="confirmation-message" class="text-xl font-semibold mb-6">Вы уверены?</h3>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="btn bg-red-600 text-white hover:bg-red-700">Да</button>
                <button id="confirm-no-btn" class="btn btn-secondary">Отмена</button>
            </div>
        </div>
    </div>
    
    <div id="results-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" data-modal-id="results-modal">&times;</button>
            <h2 class="modal-title">Результаты</h2>
            <div id="results-content" class="space-y-3 text-lg text-center"></div>
        </div>
    </div>
    
    <div id="settings-panel" class="settings-panel">
        <div class="settings-header">
            <h3 class="settings-title">Настройки</h3>
            <button id="close-settings-btn" class="close-button">&times;</button>
        </div>
        <div class="space-y-6">
            <div class="form-group">
                <label class="form-label flex justify-between items-center">
                    <span>Темная тема</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label flex justify-between items-center">
                    <span>Отключить анимации</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="animations-toggle">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            <div class="form-group">
                <label for="sort-trades-by" class="form-label">Сортировать сделки по</label>
                <select id="sort-trades-by" class="form-select">
                    <option value="date_desc">Сначала новые</option>
                    <option value="date_asc">Сначала старые</option>
                    <option value="profit_desc">Самые прибыльные</option>
                    <option value="profit_asc">Самые убыточные</option>
                </select>
            </div>
            <div class="form-group">
                <label for="default-margin" class="form-label">Маржа по умолчанию</label>
                <input type="number" id="default-margin" class="form-input" placeholder="1">
            </div>
            <div class="space-y-3">
                <button id="export-data-btn" class="btn btn-secondary w-full">Экспорт данных</button>
                <button id="import-data-btn" class="btn btn-secondary w-full">Импорт данных</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
            <div class="border-t border-dashed pt-6 mt-6 space-y-3 border-red-500/50">
                 <button id="delete-all-stats-btn" class="btn bg-red-600/10 text-red-500 hover:bg-red-600/20 w-full">Удалить все статистики</button>
                 <button id="clear-memory-btn" class="btn bg-red-600/10 text-red-500 hover:bg-red-600/20 w-full">Очистить память</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let statistics = {};
            let currentStatisticId = null;
            let currentEditingTrade = null;
            let currentEditingStatisticIdForName = null;
            let confirmationCallback = null;
            let addTradeInitiatedCreateStatistic = false;
            let settings = {};

            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const app = {
                init() {
                    this.loadSettings();
                    this.applySettings();
                    this.loadData();
                    this.attachEventListeners();
                    this.renderStatisticsList();
                    
                    if (currentStatisticId && statistics[currentStatisticId]) {
                        this.renderTradeDetail(currentStatisticId);
                    } else {
                        $('#trade-detail-view').classList.add('hidden');
                        $('#statistics-overview').classList.remove('hidden');
                    }
                },

                attachEventListeners() {
                    $('#create-statistic-btn').addEventListener('click', () => this.openModal('create-statistic-modal'));
                    $('#add-trade-btn').addEventListener('click', () => this.handleAddTradeClick());
                    $('#back-to-stats-btn').addEventListener('click', () => this.showStatisticsOverview());
                    $('#create-statistic-form').addEventListener('submit', (e) => this.handleStatisticFormSubmit(e));
                    $('#add-trade-form').addEventListener('submit', (e) => this.handleTradeFormSubmit(e));
                    $('#confirm-yes-btn').addEventListener('click', () => this.handleConfirmYes());
                    $('#confirm-no-btn').addEventListener('click', () => this.closeModal('confirmation-modal'));
                    $('#copy-current-statistic-btn').addEventListener('click', () => this.copyCurrentStatistic());
                    $('#show-results-btn').addEventListener('click', () => this.showResults(currentStatisticId));
                    $('#settings-btn').addEventListener('click', () => $('#settings-panel').classList.add('active'));
                    $('#close-settings-btn').addEventListener('click', () => $('#settings-panel').classList.remove('active'));
                    $('#theme-toggle').addEventListener('change', (e) => this.updateSetting('theme', e.target.checked ? 'dark' : 'light'));
                    $('#animations-toggle').addEventListener('change', (e) => this.updateSetting('animationsDisabled', e.target.checked));
                    $('#sort-trades-by').addEventListener('change', (e) => this.updateSetting('sortTradesBy', e.target.value));
                    $('#default-margin').addEventListener('input', (e) => this.updateSetting('defaultMargin', e.target.value));
                    $('#export-data-btn').addEventListener('click', () => this.exportData());
                    $('#import-data-btn').addEventListener('click', () => $('#import-file-input').click());
                    $('#import-file-input').addEventListener('change', (e) => this.importData(e));
                    $('#delete-all-stats-btn').addEventListener('click', () => this.confirmAction('Вы уверены, что хотите удалить ВСЕ статистики?', () => this.deleteAllStatistics()));
                    $('#clear-memory-btn').addEventListener('click', () => this.confirmAction('Это действие удалит ВСЕ данные приложения. Продолжить?', () => this.clearMemory()));
                    
                    $('#add-trade-form').addEventListener('input', () => this.updateTradePreview());

                    document.body.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal-overlay')) {
                            this.closeAllModals();
                        }
                        const settingsPanel = $('#settings-panel');
                        if (settingsPanel.classList.contains('active') && !settingsPanel.contains(e.target) && !e.target.closest('#settings-btn')) {
                            settingsPanel.classList.remove('active');
                        }
                        if (e.target.classList.contains('close-button')) {
                            this.closeModal(e.target.dataset.modalId);
                        }
                        if (e.target.closest('.statistic-card')) {
                            const card = e.target.closest('.statistic-card');
                            const id = card.dataset.id;
                            if (e.target.closest('.edit-statistic-name-btn')) {
                                this.editStatisticName(id);
                            } else if (e.target.closest('.delete-statistic-btn')) {
                                this.confirmAction('Удалить эту статистику и все ее сделки?', () => this.deleteStatistic(id, card));
                            } else {
                                currentStatisticId = id;
                                this.renderTradeDetail(id);
                            }
                        }
                        if (e.target.closest('.add-fixation-btn')) {
                            this.addFixationField();
                        }
                        if (e.target.closest('.remove-fixation-btn')) {
                            this.removeFixationField(e.target.closest('.remove-fixation-btn'));
                        }
                        if (e.target.closest('.copy-trade-single-btn')) {
                            const tradeId = e.target.closest('.copy-trade-single-btn').dataset.tradeId;
                            this.copySingleTrade(tradeId);
                        }
                        if (e.target.closest('.edit-trade-btn')) {
                            const tradeId = e.target.closest('.edit-trade-btn').dataset.tradeId;
                            this.editTrade(currentStatisticId, tradeId);
                        }
                        if (e.target.closest('.delete-trade-btn')) {
                            const tradeId = e.target.closest('.delete-trade-btn').dataset.tradeId;
                            const tradeCard = e.target.closest('.trade-card');
                            this.confirmAction('Удалить эту сделку?', () => this.deleteTrade(currentStatisticId, tradeId, tradeCard));
                        }
                         if (e.target.matches('.direction-btn')) {
                            this.handleDirectionSelection(e.target);
                            this.updateTradePreview();
                        }
                    });
                     document.body.addEventListener('change', (e) => {
                        if (e.target.classList.contains('trade-date-input')) {
                            const tradeId = e.target.closest('.trade-card').dataset.tradeId;
                            this.updateTradeDate(currentStatisticId, tradeId, e.target.value);
                        }
                         if (e.target.id === 'select-statistic') {
                            this.updateTradePreview();
                        }
                    });
                },
                
                loadSettings() {
                    const savedSettings = localStorage.getItem('tradeStatisticsSettings');
                    const defaultSettings = {
                        theme: 'dark',
                        animationsDisabled: false,
                        sortTradesBy: 'date_desc',
                        defaultMargin: 1,
                    };
                    settings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
                },

                saveSettings() {
                    localStorage.setItem('tradeStatisticsSettings', JSON.stringify(settings));
                },
                
                updateSetting(key, value) {
                    settings[key] = value;
                    this.saveSettings();
                    this.applySettings();
                    if (key === 'sortTradesBy' && currentStatisticId) {
                        this.renderTradeDetail(currentStatisticId);
                    }
                },

                applySettings() {
                    document.documentElement.setAttribute('data-theme', settings.theme);
                    $('#theme-toggle').checked = settings.theme === 'dark';
                    
                    document.body.classList.toggle('animations-disabled', settings.animationsDisabled);
                    $('#animations-toggle').checked = settings.animationsDisabled;

                    $('#sort-trades-by').value = settings.sortTradesBy;
                    $('#default-margin').value = settings.defaultMargin;
                },

                loadData() {
                    const storedData = localStorage.getItem('tradeStatistics');
                    if (storedData) {
                        statistics = JSON.parse(storedData);
                    }
                    const storedCurrentStat = localStorage.getItem('currentStatisticId');
                    if (storedCurrentStat && statistics[storedCurrentStat]) {
                        currentStatisticId = storedCurrentStat;
                    }
                },

                saveData() {
                    localStorage.setItem('tradeStatistics', JSON.stringify(statistics));
                    if (currentStatisticId) {
                        localStorage.setItem('currentStatisticId', currentStatisticId);
                    } else {
                        localStorage.removeItem('currentStatisticId');
                    }
                },
                
                renderStatisticsList() {
                    const listContainer = $('#statistics-list');
                    listContainer.innerHTML = '';
                    const statisticIds = Object.keys(statistics);

                    $('#add-trade-btn').style.display = statisticIds.length > 0 ? 'inline-flex' : 'none';
                    $('#no-statistics-message').classList.toggle('hidden', statisticIds.length > 0);
                    listContainer.classList.toggle('hidden', statisticIds.length === 0);
                    
                    if(statisticIds.length === 0) {
                        $('#create-statistic-btn').classList.add('pulsate-animation');
                    } else {
                        $('#create-statistic-btn').classList.remove('pulsate-animation');
                    }

                    statisticIds.forEach((id, index) => {
                        const stat = statistics[id];
                        const metrics = this.calculateStatisticMetrics(id);
                        const winRateColor = metrics.winRate > 50 ? 'color-green' : metrics.winRate < 50 ? 'color-red' : 'color-gray';
                        const netMoveColor = metrics.totalNetMovement > 0 ? 'color-green' : metrics.totalNetMovement < 0 ? 'color-red' : 'color-gray';

                        const card = document.createElement('div');
                        card.className = 'statistic-card';
                        card.dataset.id = id;
                        card.style.animationDelay = `${index * 70}ms`;
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold pr-2">${stat.name}</h3>
                                <div class="flex-shrink-0 flex gap-1">
                                    <button class="edit-statistic-name-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)]" title="Редактировать"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button>
                                    <button class="delete-statistic-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)] text-red-500" title="Удалить"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                </div>
                            </div>
                            <div class="text-sm text-[var(--text-secondary)] mb-4">Всего сделок: ${metrics.totalTrades}</div>
                            <div class="flex justify-between items-end text-sm">
                                <div>
                                    <div class="text-[var(--text-secondary)]">Винрейт</div>
                                    <div class="font-bold text-lg ${winRateColor}">${metrics.winRate.toFixed(2)}%</div>
                                </div>
                                <div>
                                    <div class="text-[var(--text-secondary)]">Чистое движение</div>
                                    <div class="font-bold text-lg ${netMoveColor}">${metrics.totalNetMovement.toFixed(2)}%</div>
                                </div>
                            </div>`;
                        listContainer.appendChild(card);
                        card.classList.add('animate-fade-in-up');
                    });
                },
                
                renderTradeDetail(statisticId) {
                    $('#statistics-overview').classList.add('hidden');
                    $('#trade-detail-view').classList.remove('hidden');

                    const stat = statistics[statisticId];
                    $('#detail-statistic-name').textContent = stat.name;
                    const tradeListContainer = $('#trade-list');
                    tradeListContainer.innerHTML = '';
                    
                    if (!stat.trades || stat.trades.length === 0) {
                        $('#no-trades-message').classList.remove('hidden');
                        return;
                    }
                    
                    $('#no-trades-message').classList.add('hidden');

                    const sortedTrades = this.sortTrades([...stat.trades]);

                    sortedTrades.forEach((trade, index) => {
                        const metrics = this.calculateTradeMetrics(trade);
                        trade.netMovement = metrics.netMovement;
                        
                        const profitLossClass = trade.netMovement > 0 ? 'profit-loss-green' : trade.netMovement < 0 ? 'profit-loss-red' : 'profit-loss-gray';
                        const fixationsString = trade.fixations.map(f => `${f.price} (${f.percent}%)`).join(' ');
                        const directionText = trade.direction === 'long' ? '<span class="color-green">long</span>' : '<span class="color-red">short</span>';
                        const dateValue = trade.date ? new Date(trade.date).toISOString().split('T')[0] : '';

                        const newCard = document.createElement('div');
                        newCard.className = 'trade-card animate-slide-in-left';
                        newCard.dataset.tradeId = trade.id;
                        newCard.style.animationDelay = `${index * 60}ms`;
                        newCard.innerHTML = `
                            <div class="flex justify-between items-start gap-4">
                                <div>
                                    <h4 class="text-lg font-semibold">${trade.coin} (${directionText})</h4>
                                    <div class="text-sm text-[var(--text-secondary)] mt-1">
                                        ENTRY: ${trade.entry} &bull; Маржа: X${trade.margin}
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-bold ${profitLossClass} flex-shrink-0">
                                    ${trade.netMovement.toFixed(2)}%
                                </span>
                            </div>
                            <div class="text-sm text-[var(--text-secondary)] mt-3">Фиксации: ${fixationsString}</div>
                            <div class="flex justify-between items-center mt-4">
                                 <input type="date" value="${dateValue}" class="trade-date-input bg-transparent border-none p-0 text-[var(--text-secondary)]" title="Изменить дату">
                                 <div class="flex gap-1">
                                    <button class="copy-trade-single-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)]" data-trade-id="${trade.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button>
                                    <button class="delete-trade-btn p-1.5 rounded-md hover:bg-[var(--gray-bg)] text-red-500" data-trade-id="${trade.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                 </div>
                            </div>`;
                        
                        newCard.addEventListener('click', (e) => {
                            if (e.target.closest('button') || e.target.closest('input')) {
                                return;
                            }
                            this.copySingleTrade(trade.id);
                        });

                        tradeListContainer.appendChild(newCard);
                    });
                },
                
                sortTrades(trades) {
                    const sortOrder = settings.sortTradesBy;
                    return trades.sort((a, b) => {
                        const aTimestamp = a.timestamp || 0;
                        const bTimestamp = b.timestamp || 0;
                        const aNetMovement = a.netMovement || 0;
                        const bNetMovement = b.netMovement || 0;

                        switch (sortOrder) {
                            case 'date_asc': return aTimestamp - bTimestamp;
                            case 'profit_desc': return bNetMovement - aNetMovement;
                            case 'profit_asc': return aNetMovement - bNetMovement;
                            case 'date_desc':
                            default:
                                return bTimestamp - aTimestamp;
                        }
                    });
                },

                calculateTradeMetrics(trade) {
                    let totalContribution = 0;
                    if (trade.fixations && trade.fixations.length > 0) {
                        trade.fixations.forEach(fix => {
                            const price = parseFloat(fix.price);
                            const percent = parseFloat(fix.percent);
                            if (isNaN(price) || isNaN(percent) || percent === 0 || !trade.entry) return;
                            const entry = parseFloat(trade.entry);
                            let movementDecimal = trade.direction === 'long' ? (price - entry) / entry : (entry - price) / entry;
                            totalContribution += movementDecimal * (percent / 100);
                        });
                    }
                    const netMovementPercentage = totalContribution * 100 * parseFloat(trade.margin || 1);
                    return { netMovement: netMovementPercentage };
                },

                calculateStatisticMetrics(statisticId) {
                    const stat = statistics[statisticId];
                    if (!stat || !stat.trades || stat.trades.length === 0) {
                        return { totalTrades: 0, profitableTrades: 0, rejectedTrades: 0, breakevenTrades: 0, winRate: 0, totalNetMovement: 0 };
                    }
                    let profitableTrades = 0, rejectedTrades = 0, breakevenTrades = 0, totalNetMovement = 0;
                    stat.trades.forEach(trade => {
                        const metrics = this.calculateTradeMetrics(trade);
                        trade.netMovement = metrics.netMovement;
                        if (trade.netMovement > 0) profitableTrades++;
                        else if (trade.netMovement < 0) rejectedTrades++;
                        else breakevenTrades++;
                        totalNetMovement += trade.netMovement;
                    });
                    
                    const tradesForWinRate = stat.trades.length - breakevenTrades;
                    const winRate = (tradesForWinRate > 0) ? (profitableTrades / tradesForWinRate) * 100 : 0;
                    return { totalTrades: stat.trades.length, profitableTrades, rejectedTrades, breakevenTrades, winRate, totalNetMovement };
                },
                
                openModal(modalId) {
                    const modal = $(`#${modalId}`);
                    if (modal) {
                        modal.classList.add('active');
                        if (modalId === 'add-trade-modal') {
                            this.resetAddTradeForm();
                            this.updateTradePreview();
                            const previewPane = $('#trade-preview-pane');
                            previewPane.classList.remove('animate-slide-in-right');
                            setTimeout(() => previewPane.classList.add('animate-slide-in-right'), 10);
                        }
                    }
                },
                
                closeModal(modalId) {
                    const modal = $(`#${modalId}`);
                    if (modal) modal.classList.remove('active');
                },

                closeAllModals() {
                    $$('.modal-overlay').forEach(modal => modal.classList.remove('active'));
                },
                
                showToast(message) {
                    const toast = $('#toast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                },

                confirmAction(message, callback) {
                    $('#confirmation-message').textContent = message;
                    confirmationCallback = callback;
                    this.openModal('confirmation-modal');
                },
                
                handleConfirmYes() {
                    if (confirmationCallback) confirmationCallback();
                    this.closeModal('confirmation-modal');
                },

                handleStatisticFormSubmit(e) {
                    e.preventDefault();
                    const statisticName = $('#statistic-name').value.trim();
                    if (!statisticName) return;
                    let newStatisticId = null;
                    if (currentEditingStatisticIdForName) {
                        statistics[currentEditingStatisticIdForName].name = statisticName;
                        currentEditingStatisticIdForName = null;
                    } else {
                        newStatisticId = `stat-${crypto.randomUUID()}`;
                        statistics[newStatisticId] = { name: statisticName, trades: [] };
                    }
                    this.saveData();
                    this.renderStatisticsList();
                    this.closeModal('create-statistic-modal');
                    if (addTradeInitiatedCreateStatistic && newStatisticId) {
                        this.populateStatisticSelect(newStatisticId);
                        this.openModal('add-trade-modal');
                        addTradeInitiatedCreateStatistic = false;
                    }
                },
                
                handleTradeFormSubmit(e) {
                    e.preventDefault();
                    const selectedStatisticId = $('#select-statistic').value;
                    const coinName = $('#coin-name').value.trim().toUpperCase();
                    const direction = $('#direction-hidden-input').value;
                    const entryPrice = parseFloat($('#entry-price').value);
                    const margin = parseFloat($('#margin').value);

                    let fixations = [], totalFixationPercent = 0;
                    $$('#fixations-container .flex').forEach(row => {
                        const price = parseFloat(row.querySelector('.fixation-price').value);
                        const percent = parseFloat(row.querySelector('.fixation-percent').value);
                        if (!isNaN(price) && !isNaN(percent)) {
                            fixations.push({ price, percent });
                            totalFixationPercent += percent;
                        }
                    });

                    if (totalFixationPercent > 100.001) {
                        $('#fixation-total-warning').classList.remove('hidden');
                        return;
                    }
                    $('#fixation-total-warning').classList.add('hidden');

                    const targetStatisticId = currentEditingTrade ? currentStatisticId : selectedStatisticId;
                    if (!targetStatisticId || !coinName || isNaN(entryPrice) || isNaN(margin) || !direction) return;

                    if (currentEditingTrade) {
                        const tradeIndex = statistics[currentStatisticId].trades.findIndex(t => t.id === currentEditingTrade.id);
                        if (tradeIndex !== -1) {
                            const tradeToUpdate = statistics[currentStatisticId].trades[tradeIndex];
                            Object.assign(tradeToUpdate, { coin: coinName, direction, entry: entryPrice, fixations, margin, timestamp: tradeToUpdate.timestamp });
                        }
                    } else {
                        const newTrade = { id: `trade-${crypto.randomUUID()}`, coin: coinName, direction, entry: entryPrice, fixations, margin, date: new Date().toISOString(), timestamp: Date.now() };
                        statistics[targetStatisticId].trades.push(newTrade);
                    }
                    
                    this.saveData();
                    this.renderStatisticsList();
                    this.closeModal('add-trade-modal');
                    if (currentStatisticId === targetStatisticId) {
                        this.renderTradeDetail(currentStatisticId);
                    }
                },
                
                handleAddTradeClick() {
                    const statIds = Object.keys(statistics);
                    if (statIds.length === 0) {
                        addTradeInitiatedCreateStatistic = true;
                        this.openModal('create-statistic-modal');
                        return;
                    }
                    this.populateStatisticSelect();
                    if (currentStatisticId) {
                         $('#select-statistic').value = currentStatisticId;
                    } else if (statIds.length === 1) {
                        $('#select-statistic').value = statIds[0];
                    }
                    this.openModal('add-trade-modal');
                },
                
                showStatisticsOverview() {
                    $('#trade-detail-view').classList.add('hidden');
                    $('#statistics-overview').classList.remove('hidden');
                    currentStatisticId = null;
                    this.saveData();
                    this.renderStatisticsList();
                },

                editStatisticName(id) {
                    currentEditingStatisticIdForName = id;
                    const stat = statistics[id];
                    $('#create-statistic-modal-title').textContent = 'Редактировать Статистику';
                    $('#create-statistic-submit-btn').textContent = 'Обновить';
                    $('#statistic-name').value = stat.name;
                    this.openModal('create-statistic-modal');
                },

                deleteStatistic(id, cardElement) {
                    cardElement.classList.add('animate-delete');
                    
                    setTimeout(() => {
                        delete statistics[id];
                        if (currentStatisticId === id) {
                            currentStatisticId = null;
                        }
                        this.saveData();
                        this.showStatisticsOverview();
                    }, 400);
                },
                
                editTrade(statisticId, tradeId) {
                    currentEditingTrade = statistics[statisticId].trades.find(t => t.id === tradeId);
                    if (!currentEditingTrade) return;

                    $('#add-trade-modal-title').textContent = 'Редактировать Сделку';
                    $('#add-trade-submit-btn').textContent = 'Обновить';
                    $('#select-statistic-container').classList.add('hidden');
                    
                    $('#coin-name').value = currentEditingTrade.coin;
                    this.setDirectionSelector(currentEditingTrade.direction);
                    $('#entry-price').value = currentEditingTrade.entry;
                    $('#margin').value = currentEditingTrade.margin;

                    const fixationsContainer = $('#fixations-container');
                    fixationsContainer.innerHTML = '';
                    currentEditingTrade.fixations.forEach(fix => this.addFixationField(fix.price, fix.percent));
                    if (currentEditingTrade.fixations.length === 0) this.addFixationField();
                    
                    this.openModal('add-trade-modal');
                },
                
                deleteTrade(statisticId, tradeId, cardElement) {
                    cardElement.classList.add('animate-delete');
                    
                    setTimeout(() => {
                        const stat = statistics[statisticId];
                        if (stat) {
                            stat.trades = stat.trades.filter(t => t.id !== tradeId);
                            this.saveData();
                            this.renderTradeDetail(statisticId);
                            this.renderStatisticsList();
                        }
                    }, 400);
                },
                
                updateTradeDate(statisticId, tradeId, newDateString) {
                    const trade = statistics[statisticId]?.trades.find(t => t.id === tradeId);
                    if (trade) {
                        trade.date = newDateString ? new Date(newDateString).toISOString() : null;
                        trade.timestamp = newDateString ? new Date(newDateString).getTime() : Date.now();
                        this.saveData();
                        this.renderTradeDetail(statisticId);
                    }
                },
                
                resetAddTradeForm() {
                    $('#add-trade-form').reset();
                    $('#add-trade-modal-title').textContent = 'Добавить Сделку';
                    $('#add-trade-submit-btn').textContent = 'Добавить';
                    $('#select-statistic-container').classList.remove('hidden');
                    $('#fixations-container').innerHTML = '';
                    this.addFixationField();
                    $('#margin').value = settings.defaultMargin;
                    this.setDirectionSelector('long');
                    currentEditingTrade = null;
                    this.updateTradePreview();
                },

                addFixationField(price = '', percent = '') {
                    const container = $('#fixations-container');
                    const isFirst = container.children.length === 0;
                    const newField = document.createElement('div');
                    newField.className = 'flex items-center gap-2 animate-fade-in-up';
                    newField.style.animationDuration = '0.3s';
                    newField.innerHTML = `
                        <input type="number" step="any" class="fixation-price form-input" placeholder="Цена" value="${price}">
                        <input type="number" step="any" min="0" max="100" class="fixation-percent form-input" placeholder="%" value="${percent}">
                        <button type="button" class="${isFirst ? 'add-fixation-btn text-green-500' : 'remove-fixation-btn text-red-500'} p-2 rounded-md hover:bg-[var(--gray-bg)] transition-transform hover:scale-110">
                            ${isFirst ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>'}
                        </button>
                    `;
                    container.appendChild(newField);
                },

                removeFixationField(button) {
                    const field = button.closest('.flex');
                    field.classList.add('animate-delete');
                    setTimeout(() => field.remove(), 400);
                },

                handleDirectionSelection(clickedButton) {
                    const value = clickedButton.dataset.value;
                    this.setDirectionSelector(value);
                },

                setDirectionSelector(value) {
                    $('#direction-hidden-input').value = value;
                    $$('.direction-btn').forEach(btn => {
                        btn.classList.remove('selected-long', 'selected-short');
                    });
                    const targetButton = $(`.direction-btn[data-value="${value}"]`);
                    if (targetButton) {
                        targetButton.classList.add(value === 'long' ? 'selected-long' : 'selected-short');
                    }
                },
                
                updateTradePreview() {
                    const form = $('#add-trade-form');
                    const previewContent = $('#preview-content');
                    const placeholder = $('#preview-placeholder');

                    const coinName = form.querySelector('#coin-name').value.trim().toUpperCase();
                    const direction = form.querySelector('#direction-hidden-input').value;
                    const entryPrice = parseFloat(form.querySelector('#entry-price').value);
                    const margin = parseFloat(form.querySelector('#margin').value);
                    const statisticId = form.querySelector('#select-statistic').value;
                    const statisticName = statisticId && statistics[statisticId] ? statistics[statisticId].name : 'Не выбрана';

                    let fixations = [];
                    form.querySelectorAll('#fixations-container .flex').forEach(row => {
                        const price = parseFloat(row.querySelector('.fixation-price').value);
                        const percent = parseFloat(row.querySelector('.fixation-percent').value);
                        if (!isNaN(price) && !isNaN(percent) && percent > 0) {
                            fixations.push({ price, percent });
                        }
                    });

                    if (!coinName && isNaN(entryPrice)) {
                        previewContent.innerHTML = '';
                        placeholder.classList.remove('hidden');
                        return;
                    }

                    placeholder.classList.add('hidden');

                    const tempTrade = {
                        entry: entryPrice,
                        margin: isNaN(margin) ? settings.defaultMargin : margin,
                        direction: direction,
                        fixations: fixations
                    };

                    const metrics = this.calculateTradeMetrics(tempTrade);
                    const netMovement = metrics.netMovement;

                    const netMoveColor = netMovement > 0 ? 'color-green' : netMovement < 0 ? 'color-red' : 'color-gray';
                    const directionText = direction === 'long' ? `<span class="color-green font-semibold">LONG</span>` : `<span class="color-red font-semibold">SHORT</span>`;

                    previewContent.innerHTML = `
                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">
                            <div class="text-sm text-[var(--text-secondary)]">Монета</div>
                            <div class="text-xl font-bold">${coinName || '...'}</div>
                        </div>
                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">
                            <div class="text-sm text-[var(--text-secondary)]">Направление</div>
                            <div class="text-xl">${directionText}</div>
                        </div>
                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">
                            <div class="text-sm text-[var(--text-secondary)]">Чистое движение</div>
                            <div class="text-2xl font-bold ${netMoveColor}">${isNaN(netMovement) ? '0.00' : netMovement.toFixed(2)}%</div>
                        </div>
                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">
                            <div class="text-sm text-[var(--text-secondary)]">Маржа</div>
                            <div class="text-xl font-bold">X${isNaN(margin) ? settings.defaultMargin : margin}</div>
                        </div>
                        <div class="preview-item p-3 rounded-lg bg-[var(--bg-secondary)] transition-all duration-200">
                            <div class="text-sm text-[var(--text-secondary)]">Статистика</div>
                            <div class="text-lg font-semibold truncate" title="${statisticName}">${statisticName}</div>
                        </div>
                    `;
                },

                populateStatisticSelect(preSelectId = null) {
                    const select = $('#select-statistic');
                    select.innerHTML = '<option value="">-- Выберите статистику --</option>';
                    Object.keys(statistics).forEach(id => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = statistics[id].name;
                        select.appendChild(option);
                    });
                    if (preSelectId) select.value = preSelectId;
                },
                
                copyToClipboard(text) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        this.showToast('Скопировано в буфер обмена!');
                    } catch (err) {
                        this.showToast('Ошибка при копировании');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                },

                generateSingleTradeExportText(trade) {
                    const directionText = trade.direction === 'long' ? 'long' : 'short';
                    const fixationsString = trade.fixations.map(f => `${f.price} (${f.percent}%)`).join(' ');
                    const tradeDateString = trade.date ? new Date(trade.date).toLocaleDateString('ru-RU') : 'Нет даты';
                    const metrics = this.calculateTradeMetrics(trade);
                    return `${trade.coin} (${directionText})\nЧистое движение: ${metrics.netMovement.toFixed(2)}%\nENTRY: ${trade.entry}\nМаржа: X${trade.margin}\nФиксации: ${fixationsString}\nДата: ${tradeDateString}`;
                },
                
                copySingleTrade(tradeId) {
                    const trade = statistics[currentStatisticId].trades.find(t => t.id === tradeId);
                    if(trade) this.copyToClipboard(this.generateSingleTradeExportText(trade));
                },

                copyCurrentStatistic() {
                    let exportContent = `--- Статистика: ${statistics[currentStatisticId].name} ---\n\n`;
                    const sortedTrades = this.sortTrades([...statistics[currentStatisticId].trades]);
                    sortedTrades.forEach(trade => {
                        exportContent += this.generateSingleTradeExportText(trade) + '\n\n';
                    });
                    this.copyToClipboard(exportContent.trim());
                },
                
                animateCountUp(el, end, duration = 800, isPercent = false) {
                    if (!el) return;
                    let startTimestamp = null;
                    const startValue = 0;
                    const endValue = parseFloat(end);

                    if (isNaN(endValue)) return;

                    const step = (timestamp) => {
                        if (!startTimestamp) startTimestamp = timestamp;
                        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                        const currentValue = progress * (endValue - startValue) + startValue;
                        
                        if (isPercent) {
                            el.textContent = `${currentValue.toFixed(2)}%`;
                        } else {
                            el.textContent = Math.floor(currentValue);
                        }

                        if (progress < 1) {
                            window.requestAnimationFrame(step);
                        } else {
                            if (isPercent) {
                                el.textContent = `${endValue.toFixed(2)}%`;
                            } else {
                                el.textContent = Math.round(endValue);
                            }
                        }
                    };

                    window.requestAnimationFrame(step);
                },

                showResults(statisticId) {
                    const metrics = this.calculateStatisticMetrics(statisticId);
                    const contentEl = $('#results-content');
                    contentEl.innerHTML = `
                        <p>Чистое движение: <span id="res-net" class="font-bold ${metrics.totalNetMovement > 0 ? 'color-green' : metrics.totalNetMovement < 0 ? 'color-red' : 'color-gray'}">0.00%</span></p>
                        <p>Винрейт: <span id="res-winrate" class="font-bold ${metrics.winRate > 50 ? 'color-green' : metrics.winRate < 50 ? 'color-red' : 'color-gray'}">0.00%</span></p>
                        <p>Всего сделок: <span id="res-total" class="font-bold">0</span></p>
                        <p>Успешных: <span id="res-profit" class="font-bold color-green">0</span></p>
                        <p>Убыточных: <span id="res-loss" class="font-bold color-red">0</span></p>
                        <p>В безубыток: <span id="res-be" class="font-bold color-gray">0</span></p>
                    `;
                    this.openModal('results-modal');
                    
                    this.animateCountUp($('#res-net'), metrics.totalNetMovement, 800, true);
                    this.animateCountUp($('#res-winrate'), metrics.winRate, 800, true);
                    this.animateCountUp($('#res-total'), metrics.totalTrades);
                    this.animateCountUp($('#res-profit'), metrics.profitableTrades);
                    this.animateCountUp($('#res-loss'), metrics.rejectedTrades);
                    this.animateCountUp($('#res-be'), metrics.breakevenTrades);
                },
                
                deleteAllStatistics() {
                    statistics = {};
                    this.saveData();
                    this.renderStatisticsList();
                    this.showStatisticsOverview();
                },
                
                clearMemory() {
                    localStorage.clear();
                    window.location.reload();
                },
                
                exportData() {
                    const dataStr = JSON.stringify({ statistics, settings }, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = 'trade_stats_backup.json';
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                },

                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.statistics && data.settings) {
                                statistics = data.statistics;
                                settings = data.settings;
                                this.saveData();
                                this.saveSettings();
                                this.applySettings();
                                this.renderStatisticsList();
                                this.showStatisticsOverview();
                                this.showToast('Данные успешно импортированы!');
                            } else {
                                this.showToast('Ошибка: неверный формат файла.');
                            }
                        } catch (error) {
                            this.showToast('Ошибка при чтении файла.');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                }
            };

            app.init();
        });
    </script>
</body>
</html>
